<HTML>

<!-- Generated by c2html-1.0, Copyright 1998 by Dave Whittington -->
<HEAD>
<TITLE>arcofi.c</TITLE>
<!--#include virtual="/ssi/js.shtml" -->
<!--#include virtual="/ssi/buttondefs.shtml" -->
</HEAD>
<BODY BGCOLOR="#FFFFFF">
<TABLE WIDTH="100%">
<TR>
<TD ALIGN=LEFT WIDTH="90"><!--#include virtual="/ssi/b_home.shtml" --></TD>
<TD ALIGN=RIGHT WIDTH="90"><!--#include virtual="/ssi/b_index.shtml" --></TD>
</TR>
</TABLE>
<CENTER><H1>arcofi.c</H1></CENTER>

<HR>
<PRE>
<FONT COLOR=#0000FF>/* $Id$

 * arcofi.h   Ansteuerung ARCOFI 2165
 *
 * Author     Karsten Keil (keil@temic-ech.spacenet.de)
 *
 *
 *
 * $Log$
 * Revision 1.3  1998/05/25 12:57:38  keil
 * HiSax golden code from certification, Don't use !!!
 * No leased lines, no X75, but many changes.
 *
 * Revision 1.2  1998/04/15 16:47:16  keil
 * new interface
 *
 * Revision 1.1  1997/10/29 18:51:20  keil
 * New files
 *
 */</FONT>
 
<FONT COLOR=#A521F7>#define</FONT> <A HREF="asuscom.c.shtml#__NO_VERSION__">__NO_VERSION__</A>
<FONT COLOR=#A521F7>#include</FONT> <FONT COLOR="#FF0000">"hisax.h"</FONT>
<FONT COLOR=#A521F7>#include</FONT> <FONT COLOR="#FF0000">"isdnl1.h"</FONT>
<FONT COLOR=#A521F7>#include</FONT> <FONT COLOR="#FF0000">"isac.h"</FONT>

<FONT COLOR="#298C52">int</FONT>
send_arcofi(<FONT COLOR="#298C52">struct</FONT> IsdnCardState *cs, <FONT COLOR="#298C52">const</FONT> u_char *msg, <FONT COLOR="#298C52">int</FONT> bc, <FONT COLOR="#298C52">int</FONT> receive) {
	u_char val;
	<FONT COLOR="#298C52">char</FONT> tmp[32];
	<FONT COLOR="#298C52">long</FONT> flags;
	<FONT COLOR="#298C52">int</FONT> cnt=50;
	
	cs-&gt;mon_txp = 0;
	cs-&gt;mon_txc = msg[0];
	memcpy(cs-&gt;mon_tx, &amp;msg[1], cs-&gt;mon_txc);
	<FONT COLOR="#298C52">switch</FONT>(bc) {
		<FONT COLOR="#298C52">case</FONT> 0: <FONT COLOR="#298C52">break</FONT>;
		<FONT COLOR="#298C52">case</FONT> 1: cs-&gt;mon_tx[1] |= 0x40;
			<FONT COLOR="#298C52">break</FONT>;
		<FONT COLOR="#298C52">default</FONT>: <FONT COLOR="#298C52">break</FONT>;
	}
	cs-&gt;mocr &amp;= 0x0f;
	cs-&gt;mocr |= 0xa0;
	test_and_clear_bit(<A HREF="hisax.h.shtml#HW_MON1_TX_END">HW_MON1_TX_END</A>, &amp;cs-&gt;HW_Flags);
	<FONT COLOR="#298C52">if</FONT> (receive)
		test_and_clear_bit(<A HREF="hisax.h.shtml#HW_MON1_RX_END">HW_MON1_RX_END</A>, &amp;cs-&gt;HW_Flags);
	cs-&gt;writeisac(cs, <A HREF="isac.h.shtml#ISAC_MOCR">ISAC_MOCR</A>, cs-&gt;mocr);
	val = cs-&gt;readisac(cs, <A HREF="isac.h.shtml#ISAC_MOSR">ISAC_MOSR</A>);
	cs-&gt;writeisac(cs, <A HREF="isac.h.shtml#ISAC_MOX1">ISAC_MOX1</A>, cs-&gt;mon_tx[cs-&gt;mon_txp++]);
	cs-&gt;mocr |= 0x10;
	cs-&gt;writeisac(cs, <A HREF="isac.h.shtml#ISAC_MOCR">ISAC_MOCR</A>, cs-&gt;mocr);
	save_flags(flags);
	sti();
	<FONT COLOR="#298C52">while</FONT> (cnt &amp;&amp; !test_bit(<A HREF="hisax.h.shtml#HW_MON1_TX_END">HW_MON1_TX_END</A>, &amp;cs-&gt;HW_Flags)) {
		cnt--;
		udelay(500);
<FONT COLOR=#A521F7>#if</FONT> 0
		current-&gt;state = TASK_INTERRUPTIBLE;
		current-&gt;timeout = jiffies + (10 * HZ) / 1000;	<FONT COLOR=#0000FF>/* Timeout 10ms */</FONT>
		schedule();
<FONT COLOR=#A521F7>#endif</FONT>
	}
	<FONT COLOR="#298C52">if</FONT> (receive) {
		<FONT COLOR="#298C52">while</FONT> (cnt &amp;&amp; !test_bit(<A HREF="hisax.h.shtml#HW_MON1_RX_END">HW_MON1_RX_END</A>, &amp;cs-&gt;HW_Flags)) {
			cnt--;
			udelay(500);
		}
	}
	restore_flags(flags);
	sprintf(tmp, <FONT COLOR="#FF0000">"arcofi tout %d"</FONT>, cnt);
	<A HREF="isdnl1.c.shtml#debugl1">debugl1</A>(cs, tmp);
	<FONT COLOR="#298C52">return</FONT>(cnt);	
}

</BODY>

</HTML>
